# tideWise 전날잔고처리 시스템 상세 가이드
================================================================================

## 📋 목차
1. 전날잔고처리 시스템 개요
2. 처리 로직 및 전략별 특성
3. 실행 과정 (단계별 상세)
4. 매매 신호 분석 시스템
5. 자동 청산 및 리밸런싱
6. 리스크 관리 및 정책
7. 실제 운용 사례 및 최적화

================================================================================

## 1. 전날잔고처리 시스템 개요

### 1.1 핵심 목적
**전날잔고처리**: 전거래일에 보유하고 있던 종목들을 당일 장 시작과 함께 체계적으로 정리하여 새로운 매매를 위한 자금을 확보하고 포트폴리오를 최적화하는 프로세스

### 1.2 시스템 구조
- **메인 클래스**: PreviousDayBalanceHandler
- **지원 전략**: Production, Simple, Minimal, DayTrading
- **실행 시점**: 장 개시 직후 (09:05-09:06)
- **처리 방식**: 자동화된 알고리즘 기반 판단

### 1.3 핵심 기능
```
전날잔고처리 통합 시스템:
├── 보유 종목 손익 분석
├── 매매 신호 재평가
├── 자동 청산 실행
├── 포트폴리오 리밸런싱
└── 신규 매매 자금 확보
```

### 1.4 전략별 특성화
- **Production**: 고급 분석 기반 정교한 처리
- **Simple**: 기본적인 손익 기준 처리
- **Minimal**: 최소한의 필수 처리만
- **DayTrading**: 단타 특화 빠른 청산

================================================================================

## 2. 처리 로직 및 전략별 특성

### 2.1 공통 처리 로직

**기본 분석 요소**:
- 현재 손익률 계산
- 보유 기간 분석
- 시장 환경 평가
- 개별 종목 강도 분석

**의사결정 요소**:
- 손절 기준 (-5% 기본)
- 익절 기준 (+7% 기본)
- 보유 기간 (3일 이상시 검토)
- 시장 트렌드 (상승/하락/횡보)

### 2.2 전략별 특성화 설정

**Production 전략**:
```python
stop_loss_rate: -0.05      # 손절 기준 -5%
take_profit_rate: 0.07     # 익절 기준 +7%
use_david_paul: True       # David Paul 분석 사용
use_user_designated: True  # 사용자 지정종목 고려
volume_analysis: True      # 거래량 분석 적용
```

**Simple 전략**:
```python
stop_loss_rate: -0.04      # 손절 기준 -4%
take_profit_rate: 0.05     # 익절 기준 +5%
use_david_paul: False      # 기본 분석만
use_user_designated: False # 단순 처리
volume_analysis: False     # 거래량 분석 미사용
```

**DayTrading 전략**:
```python
stop_loss_rate: -0.02      # 손절 기준 -2% (엄격)
take_profit_rate: 0.03     # 익절 기준 +3% (보수적)
use_david_paul: False      # 빠른 처리 우선
volume_analysis: True      # 거래량 중요
```

### 2.3 FlowCache 시스템 (고급 분석)
**목적**: 실시간 거래 흐름 분석으로 정확한 매도 타이밍 포착

**추적 데이터**:
- ask_total: 예약 매도물량 (상위 N호가 합)
- bid_total: 예약 매수물량 (상위 N호가 합)
- buy_vol: 실제 매수체결 누적
- sell_vol: 실제 매도체결 누적

**분석 임계값**:
- 예약매도 증가: 10% 이상 → 매도 압력 증가
- 실제 매도체결: 15% 이상 → 강한 매도세
- 실제 매수체결: 10% 이상 → 매수세 유입

================================================================================

## 3. 실행 과정 (단계별 상세)

### Phase 1: 시스템 초기화 및 전략 설정
```
[1단계] 시스템 초기화
├── PreviousDayBalanceHandler 객체 생성
├── API 커넥터 연결 확인
├── 계좌 타입 설정 (REAL/MOCK)
└── 전략별 설정 로드

[2단계] 실행 시점 확인
├── 현재 시간 체크 (09:05-09:06 최적)
├── 장 개시 상태 확인
├── 시장 환경 사전 분석
└── 처리 준비 상태 점검
```

### Phase 2: 보유 종목 현황 파악
```
[3단계] 보유 종목 조회
├── API를 통한 보유 종목 전체 조회
├── 종목별 보유 수량 확인
├── 평균 매수가 정보 수집
└── 현재 평가 손익 계산

[4단계] 기본 데이터 수집
├── 종목별 현재가 조회
├── 전일 종가 대비 등락률
├── 실시간 거래량 정보
└── 호가 스프레드 분석

예시 보유 종목 정보:
종목A: 삼성전자(005930) - 보유 100주, 평균매수가 75,000원, 현재가 78,000원 (+4%)
종목B: SK하이닉스(000660) - 보유 50주, 평균매수가 120,000원, 현재가 115,000원 (-4.2%)
```

### Phase 3: 종목별 상세 분석
```
[5단계] 개별 종목 분석
├── 현재 손익률 정확한 계산
├── 보유 기간 분석 (1일차/2일차/3일차 이상)
├── 해당 종목의 테마/섹터 강도 분석
└── 기술적 지표 현재 상태 확인

[6단계] 매매 신호 재평가
├── 기존 매수 사유 재검토
├── 현재 시점에서의 매매 신호 생성
├── 알고리즘 기반 홀드/매도 판단
└── 외부 요인 (뉴스, 공시 등) 고려

종목별 분석 결과 예시:
종목A (삼성전자):
- 현재 손익률: +4% (익절 기준 미달)
- 보유 기간: 2일차
- 현재 신호: HOLD (상승 추세 지속)
- 결정: 보유 지속

종목B (SK하이닉스):
- 현재 손익률: -4.2% (손절 기준 근접)
- 보유 기간: 1일차
- 현재 신호: SELL (하락 추세)
- 결정: 즉시 매도
```

### Phase 4: 실시간 거래 흐름 분석 (고급)
```
[7단계] FlowCache 기반 심화 분석
├── 실시간 호가 변동 추적
├── 매수/매도 체결량 모니터링
├── 예약 거래량 변화 분석
└── 시장 참가자 심리 파악

[8단계] 미세 타이밍 최적화
├── 매도 최적 타이밍 포착
├── 슬리피지 최소화 전략
├── 체결 가능성 사전 평가
└── 주문 분할 여부 결정

FlowCache 분석 예시:
종목B (SK하이닉스) 실시간 분석:
- 예약 매도물량: 전분 대비 +12% 증가 (매도 압력 증가)
- 실제 매도체결: +18% 증가 (강한 매도세)
- 매수 유입: -5% 감소 (매수세 약화)
→ 결론: 즉시 매도 실행 권고
```

### Phase 5: 자동 청산 실행
```
[9단계] 매도 대상 종목 최종 결정
├── 손절 기준 도달 종목
├── 약세 전환 종목
├── 보유 기간 초과 종목
└── 포트폴리오 리밸런싱 대상

[10단계] 실제 매도 주문 실행
├── 시장가 매도 주문 (빠른 체결)
├── 주문 분할 실행 (대량의 경우)
├── 체결 확인 및 재시도
└── 매도 완료 확인

매도 실행 예시:
종목B (SK하이닉스) 매도:
- 매도 수량: 50주 전량
- 주문 방식: 시장가 매도
- 예상 체결가: 114,800원
- 실현 손실: -260,000원 (-4.3%)
- 체결 시간: 09:05:32
```

### Phase 6: 결과 처리 및 포트폴리오 업데이트
```
[11단계] 청산 결과 집계
├── 종목별 실현 손익 계산
├── 총 현금 증가분 확인
├── 포트폴리오 비중 재계산
└── 신규 투자 가능 금액 산출

[12단계] 포트폴리오 최적화
├── 보유 종목 비중 재조정
├── 신규 매매 우선순위 설정
├── 리스크 노출도 재평가
└── 다음 매매 전략 수립

최종 결과 예시:
전날잔고처리 완료:
- 처리 종목: 2개 중 1개 매도
- 실현 손익: -260,000원
- 확보 현금: +5,740,000원
- 신규 투자 가능: +5,740,000원
- 남은 보유 종목: 1개 (삼성전자)
```

================================================================================

## 4. 매매 신호 분석 시스템

### 4.1 신호 생성 로직
**다층 분석 구조**:
1. **기술적 분석**: RSI, MACD, 볼린저밴드
2. **거래량 분석**: 거래량 패턴, 체결강도
3. **추세 분석**: 단기/중기 이동평균
4. **시장 분석**: 섹터/테마 강도

### 4.2 전날잔고 특화 신호
**KEEP 신호** (보유 지속):
- 상승 추세 지속
- 목표가 미달성
- 보유 기간 적정
- 시장 환경 우호적

**SELL 신호** (매도 실행):
- 손절 기준 도달
- 하락 추세 전환
- 보유 기간 과도
- 시장 환경 악화

**PARTIAL_SELL 신호** (부분 매도):
- 익절 구간 진입
- 불확실성 증가
- 리스크 조정 필요
- 포트폴리오 재조정

### 4.3 신호 가중치 시스템
```python
신호 가중치 (Production 전략):
├── 현재 손익률: 40%
├── 기술적 지표: 25%
├── 거래량 분석: 20%
├── 시장 환경: 10%
└── 보유 기간: 5%

최종 점수 계산:
- 70점 이상: KEEP
- 30-70점: PARTIAL_SELL  
- 30점 미만: SELL
```

================================================================================

## 5. 자동 청산 및 리밸런싱

### 5.1 청산 우선순위 결정
**1순위**: 손절 기준 도달 종목
- 설정 손실률 초과 (기본 -5%)
- 추가 하락 위험 높음
- 즉시 청산 필요

**2순위**: 약세 전환 종목
- 상승 모멘텀 소실
- 하락 신호 강화
- 조기 청산 권고

**3순위**: 장기 보유 종목
- 보유 기간 3일 이상
- 명확한 방향성 부재
- 자금 효율성 저하

### 5.2 분할 청산 전략
**대량 보유시 분할 매도**:
- 1차: 전체 수량의 50%
- 2차: 시장 반응 확인 후 30%
- 3차: 최종 20% 청산

**시간 분산 청산**:
- 09:05-09:10: 긴급 청산 종목
- 09:10-09:20: 일반 청산 종목
- 09:20-09:30: 신중 검토 종목

### 5.3 리밸런싱 로직
```python
포트폴리오 재조정:
1. 현금 비중 최적화 (20-30% 유지)
2. 종목 집중도 관리 (개별 종목 최대 15%)
3. 섹터 분산 유지 (동일 섹터 최대 40%)
4. 리스크 조정 (베타값 기준 포트폴리오 베타 1.2 이하)
```

================================================================================

## 6. 리스크 관리 및 정책

### 6.1 손실 제한 정책
**개별 종목 손실 제한**:
- 1차 경고: -3% 도달시
- 2차 검토: -4% 도달시  
- 자동 청산: -5% 도달시
- 긴급 청산: -7% 도달시

**포트폴리오 손실 제한**:
- 일일 손실: 전체 자산의 -2%
- 주간 손실: 전체 자산의 -5%
- 월간 손실: 전체 자산의 -10%

### 6.2 시장 상황별 대응
**시장 급락시 (KOSPI -3% 이상)**:
- 모든 보유 종목 즉시 검토
- 손절 기준 -3%로 강화
- 신규 매수 중단
- 현금 비중 50% 이상 확보

**시장 급등시 (KOSPI +3% 이상)**:
- 익절 기준 +5%로 하향 조정
- 부분 매도 적극 검토
- 수익 실현 우선
- 리스크 노출 축소

### 6.3 예외 상황 처리
**개별 종목 이슈**:
- 급격한 뉴스 (공시, 사고 등)
- 거래 정지 위험
- 유동성 급감
→ 즉시 전량 매도

**시스템 오류**:
- API 연결 오류
- 데이터 수신 중단
- 주문 실행 오류
→ 안전 모드 전환, 수동 개입

================================================================================

## 7. 실제 운용 사례 및 최적화

### 7.1 전형적인 처리 사례

**사례 1: 수익 실현 케이스**
```
보유 종목: 네이버(035420)
- 매수가: 200,000원 (100주)
- 현재가: 214,000원 (+7%)
- 보유 기간: 2일차
- 신호 분석: PARTIAL_SELL
- 처리 결과: 50주 부분 매도 (익절 실현)
- 실현 수익: +700,000원
```

**사례 2: 손절 실행 케이스**
```
보유 종목: 카카오(035720)
- 매수가: 100,000원 (200주)
- 현재가: 94,000원 (-6%)
- 보유 기간: 1일차
- 신호 분석: SELL (손절 기준 초과)
- 처리 결과: 전량 매도 (손절 실행)
- 실현 손실: -1,200,000원
```

**사례 3: 보유 지속 케이스**
```
보유 종목: 삼성전자(005930)
- 매수가: 75,000원 (150주)
- 현재가: 77,000원 (+2.7%)
- 보유 기간: 1일차
- 신호 분석: KEEP (상승 추세 지속)
- 처리 결과: 보유 지속
- 평가 수익: +300,000원 (미실현)
```

### 7.2 성과 최적화 방법

**처리 타이밍 최적화**:
- 장 시작 5분 내 처리 완료
- 시장 변동성 높은 시간 활용
- 유동성 충분한 시점 선택

**수수료 최적화**:
- 불필요한 매매 최소화
- 분할 매도시 수수료 고려
- 세금 효율적 처리 시점

**심리적 요인 제거**:
- 완전 자동화 처리
- 감정적 판단 배제
- 객관적 기준 엄수

### 7.3 지속적 개선 방안

**데이터 기반 최적화**:
- 과거 처리 결과 분석
- 성공/실패 패턴 학습
- 파라미터 자동 조정

**시장 적응성 향상**:
- 시장 환경별 전략 차별화
- 계절적 요인 고려
- 거시경제 지표 반영

**기술적 고도화**:
- AI/ML 기반 예측 모델 도입
- 실시간 감정 분석 추가
- 고빈도 데이터 활용

================================================================================

## 8. 모니터링 및 성과 평가

### 8.1 실시간 모니터링 지표

**처리 효율성**:
- 처리 완료 시간 (목표: 5분 이내)
- 처리 성공률 (목표: 95% 이상)
- 시스템 오류율 (목표: 1% 미만)

**수익성 지표**:
- 평균 실현 수익률
- 손절 비율 및 평균 손실률
- 익절 비율 및 평균 수익률

### 8.2 일일 성과 리포트
```
전날잔고처리 일일 리포트:
===============================
처리일: 2025-08-18
총 보유 종목: 5개
처리 완료 종목: 3개 (매도) + 2개 (보유지속)

매도 종목:
1. A종목: +3.2% 익절 (+480,000원)
2. B종목: -4.8% 손절 (-720,000원)
3. C종목: +1.5% 리밸런싱 (+150,000원)

보유 지속:
1. D종목: +2.1% (상승 추세)
2. E종목: -1.2% (단기 조정)

총 실현 손익: -90,000원
확보 현금: +15,240,000원
새로운 투자 가능 금액: +15,240,000원
===============================
```

### 8.3 주간/월간 분석

**주간 트렌드 분석**:
- 처리 패턴 변화
- 수익률 추이
- 시장 환경 적응성

**월간 성과 평가**:
- 누적 수익률
- 샤프 비율
- 최대 낙폭 (MDD)
- 승률 및 평균 보유 기간

================================================================================

## 📞 지원 및 문의

**관련 모듈**:
- previous_day_balance_handler.py: 메인 처리 로직
- balance_cleanup_manager.py: 자동 정리 기능
- trading_rules.py: 매매 규칙 정의

**설정 파일**:
- trading_config.json: 기본 매매 설정
- Register_Key.md: 계좌 및 API 정보

**로그 위치**:
- logs/trading/: 매매 실행 로그
- logs/system/: 시스템 실행 로그

**⚠️ 주의사항**
- 전날잔고처리는 장 시작과 함께 자동 실행
- 손절 기준은 신중하게 설정 (기본 -5%)
- 시장 급변시 수동 개입 필요할 수 있음
- 세금 및 수수료를 고려한 실질 수익률 확인

**🔥 최적화 팁**
- 장 시작 10분 이내 모든 처리 완료 권장
- 개별 종목보다 포트폴리오 전체 관점에서 판단
- 감정에 휘둘리지 않는 기계적 처리
- 정기적인 전략 검토 및 업데이트

================================================================================
작성일: 2025-08-18
버전: tideWise v11.0
문서 유형: 전날잔고처리 전문 가이드
================================================================================